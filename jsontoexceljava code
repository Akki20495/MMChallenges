import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Iterator;

public class ExcelWriter {

    private static final String EXCEL_FILE_PATH = "data.xlsx";

    public static void main(String[] args) {
        try {
            ObjectMapper objectMapper = new ObjectMapper();

            // Sample JSON data (replace with your actual JSON data)
            String jsonData = "{\"Header1\": \"Value1\", \"Header2\": \"Value2\", \"NewHeader\": \"NewValue\"}";

            // Read JSON data
            JsonNode jsonNode = objectMapper.readTree(jsonData);

            // Check if Excel file exists or create a new one
            Workbook workbook;
            File file = new File(EXCEL_FILE_PATH);
            if (file.exists()) {
                FileInputStream inputStream = new FileInputStream(file);
                workbook = new XSSFWorkbook(inputStream);
            } else {
                workbook = new XSSFWorkbook();
            }

            // Get or create a sheet (assuming only one sheet)
            Sheet sheet = workbook.getSheetAt(0);
            if (sheet == null) {
                sheet = workbook.createSheet();
            }

            // Get the row count
            int rowCount = sheet.getPhysicalNumberOfRows();

            // Create or update headers
            Row headerRow;
            if (rowCount == 0) {
                headerRow = sheet.createRow(0);
            } else {
                headerRow = sheet.getRow(0);
            }

            // Iterate through JSON data and match headers with keys
            Iterator<String> fieldNames = jsonNode.fieldNames();
            while (fieldNames.hasNext()) {
                String fieldName = fieldNames.next();
                int headerIndex = findHeaderIndex(headerRow, fieldName);

                // If header not found, add a new one
                if (headerIndex == -1) {
                    headerIndex = headerRow.getLastCellNum();
                    Cell headerCell = headerRow.createCell(headerIndex);
                    headerCell.setCellValue(fieldName);
                }

                // Create a new row and write JSON data to the appropriate column
                Row dataRow;
                if (rowCount == 0) {
                    dataRow = sheet.createRow(1);
                } else {
                    dataRow = sheet.getRow(rowCount);
                }
                Cell dataCell = dataRow.createCell(headerIndex);
                dataCell.setCellValue(jsonNode.get(fieldName).asText());
            }

            // Save the changes to the Excel file
            try (FileOutputStream outputStream = new FileOutputStream(EXCEL_FILE_PATH)) {
                workbook.write(outputStream);
            }

            System.out.println("Data successfully written to Excel file.");

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static int findHeaderIndex(Row headerRow, String fieldName) {
        Iterator<Cell> cellIterator = headerRow.cellIterator();
        int index = 0;
        while (cellIterator.hasNext()) {
            Cell cell = cellIterator.next();
            if (cell.getStringCellValue().equals(fieldName)) {
                return index;
            }
            index++;
        }
        return -1;
    }
}